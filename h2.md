
# h2: Lempiväri: violetti

x)  Lue ja vastaa lyhyesti kysymyksiin

### Tuskan pyramidi

Tuskan pyramidin idea on, että mitä ylemmäs pyramidissa mennään, sitä vaikeampaa hyökkääjää on häiritä tai pysäyttää. Alimmalla tasolla on helppoja asioita, kuten IP-osoitteita tai hash-arvoja, mutta ne eivät hidasta hyökkääjää kauaa. Ylimmällä tasolla on hyökkääjän taktiikat, tekniikat ja toimintatavat – niiden muuttaminen on hyökkääjälle todella työlästä, joten niihin puuttumalla puolustaja aiheuttaa eniten “kipua”.

### Timanttimalli

Timanttimallissa hyökkäys nähdään neljän elementin kokonaisuutena: hyökkääjä, uhri, infrastruktuuri ja hyökkäystapa. Malli auttaa hahmottamaan, miten nämä liittyvät toisiinsa ja miten hyökkäys etenee. Kun yhtä kulmaa muutetaan tai tutkitaan tarkemmin, saadaan lisää ymmärrystä koko hyökkäyksestä ja voidaan paremmin tunnistaa tai katkaista sen ketju

a) Apache log. Asenna Apache-weppipalvelin paikalliselle virtuaalikoneellesi. Surffaa palvelimellesi salaamattomalla HTTP-yhteydellä, http://localhost . Etsi omaa sivulataustasi vastaava lokirivi. Analysoi yksi tällainen lokirivi, eli selitä sen kaikki kohdat. (Jos Apache ei ole kovin tuttu, voit tätä tehtävää varten vain asentaa sen ja testata oletusweppisivulla. Eli ei tarvitse tehdä omia kotisvuja tms.)

 
asensin apachen ja varmistin että se toimii avaamalla selaimessa localhost

<img width="1004" height="445" alt="image" src="https://github.com/user-attachments/assets/ecb0fcfe-3c99-45a5-b7ea-b1e9869f222c" />


Tutkin Apachen lokia

<img width="1004" height="54" alt="image" src="https://github.com/user-attachments/assets/9289d4a1-de3c-49d9-91fa-6dbc8d0daacc" />

 
- 127.0.0.1 = lähde-IP (localhost)
- ja  - = client identity & userid tyhjät
- [date] = pyyntöaika
- "GET / HTTP/1.1" = HTTP-metodi, polku ja protokolla
- 200 = HTTP-statuskoodi (OK)
- 3383 = vastauksen koko tavuina
- "-" = referer tyhjä
- "Mozilla/5.0 ..." = User-Agent (selaimen tunniste)b) Nmapped.

  
b) Porttiskannaa oma weppipalvelimesi käyttäen localhost-osoitetta ja 'nmap -A' päällä. Selitä tulokset. (Pelkkä http-portti 80/tcp riittää)
Aloitin asentamalla Nmap:in

 <img width="822" height="30" alt="image" src="https://github.com/user-attachments/assets/34f086cb-cf87-46fc-aee7-43beb6ea5cd5" />
 
 <img width="1004" height="446" alt="image" src="https://github.com/user-attachments/assets/14e23cc3-8074-48b7-bf3b-4641b2c7f5cc" />

sain porttiskannauksen suoritettua
Skannauksen tuloksessa näkyy kaksi avointa porttia 80/tcp joka kuuluu Apache palvelimelle ja 631/tcp joka kuuluu CUPS:lle

c) Skriptit. Mitkä skriptit olivat automaattisesti päällä, kun käytit "-A" parametria? (Näkyy avoimien porttinumeroiden alta, http-blah, http-blöh...).


- http-headers (hakee HTTP-otsakkeet)
- http-title (sivun <title>-kenttä)
- http-robots.txt (lukee robots.txt — jos löytyy)
- http-methods (tarkistaa tuetut HTTP-metodit)


d) Jäljet lokissa. Etsi weppipalvelimen lokeista jäljet porttiskannauksesta (NSE eli Nmap Scripting Engine -skripteistä skannauksessa). Löydätkö sanan "nmap" isolla tai pienellä? Selitä osumat. Millaisilla hauilla tai säännöillä voisit tunnistaa porttiskannauksen jostain muusta lokista, jos se on niin laaja, että et pysty lukemaan itse kaikkia rivejä?
Ajoin komennon


<img width="1004" height="73" alt="image" src="https://github.com/user-attachments/assets/56791dcb-4bf3-46bb-9c06-6919e9036e65" />
 
Nmap näkyy siellä, koska tein porttiskannauksen

Voisin hakea porttiskannausta esim.
grep -i "nmap" access.log


e) Wire sharking. Sieppaa verkkoliikenne porttiskannatessa Wiresharkilla. Huomaa, että localhost käyttää "Loopback adapter" eli "lo". Tallenna pcap. Etsi kohdat, joilla on sana "nmap" ja kommentoi niitä. Jokaisen paketin jokaista kohtaa ei tarvitse analysoida, yleisempi tarkastelu riittää.


Avasin Wiresharkin ja valitsin loopback(lo) localhost liikennettä siepatakseni

<img width="1004" height="464" alt="image" src="https://github.com/user-attachments/assets/74dd9fc4-5bc6-470f-8a6b-1863236191d2" />

Tallensin pcap-tiedoston ja etsin paketeista merkkijonoja nmap ja User-Agent. Löysin pyyntöjä, joissa User-Agent oli Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html


f) Net grep. Sieppaa verkkoliikenne 'ngrep' komennolla ja näytä kohdat, joissa on sana "nmap"


<img width="844" height="181" alt="image" src="https://github.com/user-attachments/assets/96f48382-98a7-4ce5-9dd5-aee4eb260cca" />
 
Toisessa terminaalissa tein porttiskannauksen

sudo nmap -A localhost

 <img width="800" height="42" alt="image" src="https://github.com/user-attachments/assets/da4fce1d-b46f-4b84-8e30-f094e2b2f753" />
 
Ja sitten alkoi tulla tulosteita

<img width="1004" height="444" alt="image" src="https://github.com/user-attachments/assets/abc1409f-9075-4176-83a7-98550a1f4b6d" />


g) Agentti. Vaihda nmap:n user-agent niin, että se näyttää tavalliselta weppiselaimelta


Kävin sivulla https://ifconfig.me/ua ja otin talteen selaimen User-Agentin

<img width="858" height="239" alt="image" src="https://github.com/user-attachments/assets/3e07c540-c49e-4676-b7c9-424ea5812da9" />

 
Sitten tein porttiskannauksen –script-argsilla

<img width="1004" height="134" alt="image" src="https://github.com/user-attachments/assets/91a26e86-e429-4c7d-92f8-def260a38ac9" />
 
h) Pienemmät jäljet. Porttiskannaa weppipalvelimesi uudelleen localhost-osoitteella. Tarkastele sekä Apachen lokia että siepattua verkkoliikennettä. Mikä on muuttunut, kun vaihdoit user-agent:n? Löytyykö lokista edelleen tekstijono "nmap"?
 

Sekä ngrep ja apache lokissa näkyi muutoksia mutta silti nmap löytyi joten ei pystynyt kokonaan piilottamaan. Ennen muutosta apachen lokissa näkyi nmapin oma user agent muutoksen jälkeen selainta muistuttava user agent. lokissa näkyy kuitenkin vielä nmap eli user agentin muuttaminen ei poistanut kaikkia viittauksia nmap:iin

<img width="1004" height="162" alt="image" src="https://github.com/user-attachments/assets/985d0a36-5907-4981-87e5-cd63992df21f" />


User agent näkyi selaimena myös wiresharkissa

<img width="1004" height="523" alt="image" src="https://github.com/user-attachments/assets/fc876076-91bf-486e-8d80-f71d8069024e" />


i)	Hieman vaikeampi: LoWeR ChEcK. Poista skritiskannauksesta viimeinenkin "nmap" -teksti. Etsi löytämääsi tekstiä /usr/share/nmap -hakemistosta ja korvaa se toisella. Tee porttiskannaus ja tarkista, että "nmap" ei näy isolla eikä pienellä kirjoitettuna Apachen lokissa eikä siepatussa verkkoliikenteessä. (Tässä tehtävässä voit muokata suoraan lua-skriptejä /usr/share/nmap alta, 'sudoedit'. Muokatun version paketoiminen siis rajataan ulos tehtävästä.)


Etsin missä nmaplowecheck, löytyy /usr/share/nmap/nselib/http.lua
 
 <img width="1004" height="43" alt="image" src="https://github.com/user-attachments/assets/15050656-5c1e-410b-bf61-861243a60a0e" />


Otin varmuuskopion

 <img width="1004" height="91" alt="image" src="https://github.com/user-attachments/assets/f06401f7-4660-4579-a64d-e107cd130d77" />


Sitten puukottamaan lua tiedostoa

<img width="1004" height="39" alt="image" src="https://github.com/user-attachments/assets/c6baf961-66c5-4227-b331-f1dedbc962c5" />


Muutin http.lua tiedostoa

<img width="991" height="173" alt="image" src="https://github.com/user-attachments/assets/979215dd-4ce9-4151-9bdc-b72ba0a6dcb9" />


Enkä enää saanut nmap näkyviin
 
<img width="1004" height="161" alt="image" src="https://github.com/user-attachments/assets/9ebdbfbf-9382-46d0-aded-be70cf716609" />


<img width="1004" height="153" alt="image" src="https://github.com/user-attachments/assets/41b4c160-6d9b-45c9-a328-d98ba32bf066" />


<img width="1004" height="241" alt="image" src="https://github.com/user-attachments/assets/4f00974a-0aae-4df1-a0d4-284a844c35f1" />


<img width="1004" height="419" alt="image" src="https://github.com/user-attachments/assets/0f88dabe-3beb-4157-b45e-f268f13f2183" />


<img width="1004" height="507" alt="image" src="https://github.com/user-attachments/assets/6b77584f-7f85-4cf1-9d1d-b1ced9eb5833" />

 
Lähteet:

https://terokarvinen.com/verkkoon-tunkeutuminen-ja-tiedustelu/#h2-lempivari-violetti 
https://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html
https://www.threatintel.academy/wp-content/uploads/2020/07/diamond-model.pdf https://httpd.apache.org/docs/2.4/logs.html
https://nmap.org/nsedoc/lib/http.html 
https://ifconfig.me/ua
https://mrtalagoz.medium.com/change-your-user-agent-in-web-pentests-bug-bounties-dont-be-a-plain-jane-98b442a0c601
https://bromiley.medium.com/full-packet-friday-ngrep-4167a5f7f5f8 
